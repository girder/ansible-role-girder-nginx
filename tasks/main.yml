---
- name: Install Nginx package
  apt:
    name: nginx-light
    force_apt_get: true
  notify:
    - Restart Nginx
  become: true
  become_user: root

- name: Remove Nginx default site config file
  file:
    state: absent
    path: "/etc/nginx/sites-enabled/default"
  notify:
    - Restart Nginx
  become: true
  become_user: root

# This must run before Certbot is used, to provide an HTTP-only config
- name: Deploy Nginx base config file
  template:
    src: base.conf.j2
    dest: "/etc/nginx/conf.d/base.conf"
    owner: root
    group: root
    mode: 0644
  notify:
    - Restart Nginx
  become: true
  become_user: root

- name: Add Certbot PPA key
  apt_key:
    id: "{{ nginx_certbot_ubuntu_apt_key }}"
    keyserver: "keyserver.ubuntu.com"
  become: true
  become_user: root

- name: Add Certbot PPA
  apt_repository:
    repo: >-
      deb
      http://ppa.launchpad.net/certbot/certbot/ubuntu
      {{ ansible_distribution_release }}
      main
    update_cache: true
  become: true
  become_user: root

- name: Install Certbot package
  apt:
    # This is Python 3, but named differently in the PPA
    name: python-certbot-nginx
    force_apt_get: true
  become: true
  become_user: root

# Nginx must be already started via systemd, or running Certbot will start its
# own instance, then orphan that Nginx process (still bound to ports) when it
# ends
- name: Ensure Nginx is running
  systemd:
    name: nginx
    state: started
  become: true
  become_user: root

# TODO: add nginx_redirect_www support to --domains option
- name: Obtain an SSL certificate from Let's Encrypt
  command: >-
    certbot certonly --nginx
    --email {{ nginx_registration_email }}
    --agree-tos
    --no-eff-email
    --cert-name {{ nginx_hostname }}
    --domains {{ nginx_hostname }}
    --rsa-key-size 4096
    --keep-until-expiring
    --non-interactive
  args:
    creates: "/etc/letsencrypt/live/{{ nginx_hostname }}/privkey.pem"
  notify:
    - Restart Nginx
  become: true
  become_user: root

- name: Add a cron job for SSL certificate renewal
  cron:
    name: certbot
    job: >-
      certbot renew
      --deploy-hook 'sudo systemctl reload nginx'
      --quiet
    special_time: daily
  become: true
  become_user: root

- name: Deploy Nginx Girder config file
  template:
    src: girder.conf.j2
    dest: "/etc/nginx/conf.d/girder.conf"
    owner: root
    group: root
    mode: 0644
  notify:
    - Restart Nginx
  become: true
  become_user: root

- name: Enable Nginx service
  systemd:
    name: nginx
    enabled: true
  become: true
  become_user: root
